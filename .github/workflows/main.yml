name: YAML Change Notifier for Charts

on:
  push:
    branches:
      - main
    paths:
      - 'Charts/**/*.yaml'
      - 'Charts/**/*.yml'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
          fetch-depth: '3'
    - name: Collect and Send POST requests for modified or added YAML files
      env:
          SPRING_BOOT_URL: ${{ secrets.SPRING_BOOT_URL }}
      run: |
        payload_array="["
        first=true
        
        for file in $(git diff --name-only --diff-filter=AM HEAD^1 HEAD | grep -E 'Charts/.*\.(yml|yaml)'); do
            author_name=$(git log -1 --pretty=format:'%an' -- "$file")
            author_email=$(git log -1 --pretty=format:'%ae' -- "$file")
            commit_time=$(git log -1 --pretty=format:'%cI' -- "$file")
            key=$(yq eval '.key' "$file")
            property=$(yq eval '.property' "$file")
            value=$(yq eval '.value' "$file")
            reason=$(yq eval '.reason' "$file")
            deleted=$(yq eval '.deleted // false' "$file")
            payload=$(jq -n \
                --arg file "$file" \
                --arg author_name "$author_name" \
                --arg author_email "$author_email" \
                --arg commit_time "$commit_time" \
                --arg key "$key" \
                --arg property "$property" \
                --argjson value "$value" \
                --arg reason "$reason" \
                --argjson deleted "$deleted" \
                '{file: $file, author: {name: $author_name, email: $author_email, time: $commit_time}, key: $key, property: $property, value: $value, reason: $reason, deleted: $deleted}')
        
            if [ "$first" = true ]; then
                payload_array="$payload_array$payload"
                first=false
            else
                payload_array="$payload_array,$payload"
            fi
        done
        
        payload_array="$payload_array]"
        curl -X POST -H "Content-Type: application/json" -d "$payload_array" "$SPRING_BOOT_URL"


# name: YAML Change Notifier for Charts

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'Charts/**/*.yaml'
#       - 'Charts/**/*.yml'

# jobs:
#   notify:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v4
#       with:
#           fetch-depth: '3'
#     - name: Send POST requests for modified or added YAML files
#       env:
#           SPRING_BOOT_URL: ${{ secrets.SPRING_BOOT_URL }}
#       run: |
#         for file in $(git diff --name-only --diff-filter=AM HEAD^1 HEAD | grep -E 'Charts/.*\.(yml|yaml)'); do
#           author_name=$(git log -1 --pretty=format:'%an' -- "$file")
#           author_email=$(git log -1 --pretty=format:'%ae' -- "$file")
#           commit_time=$(git log -1 --pretty=format:'%cI' -- "$file")
#           key=$(yq eval '.key' "$file")
#           property=$(yq eval '.property' "$file")
#           value=$(yq eval '.value' "$file")
#           reason=$(yq eval '.reason' "$file")
#           deleted=$(yq eval '.deleted // false' "$file")
#           payload=$(jq -n \
#             --arg file "$file" \
#             --arg author_name "$author_name" \
#             --arg author_email "$author_email" \
#             --arg commit_time "$commit_time" \
#             --arg key "$key" \
#             --arg property "$property" \
#             --argjson value "$value" \
#             --arg reason "$reason" \
#             --argjson deleted "$deleted" \
#             '{file: $file, author: {name: $author_name, email: $author_email, time: $commit_time}, key: $key, property: $property, value: $value, reason: $reason, deleted: $deleted}')
#           curl -X POST -H "Content-Type: application/json" -d "$payload" "$SPRING_BOOT_URL"
#         done

# payload_array="["
#         first=true
#         while IFS= read -r file; do
#           author_name=$(git log -1 --pretty=format:'%an' -- "$file")
#           author_email=$(git log -1 --pretty=format:'%ae' -- "$file")
#           commit_time=$(git log -1 --pretty=format:'%cI' -- "$file")
#           key=$(yq eval '.key' "$file")
#           property=$(yq eval '.property' "$file")
#           value=$(yq eval '.value' "$file")
#           reason=$(yq eval '.reason' "$file")
#           deleted=$(yq eval '.deleted // false' "$file")
#           payload=$(jq -n \
#             --arg file "$file" \
#             --arg author_name "$author_name" \
#             --arg author_email "$author_email" \
#             --arg commit_time "$commit_time" \
#             --arg key "$key" \
#             --arg property "$property" \
#             --argjson value "$value" \
#             --arg reason "$reason" \
#             --argjson deleted "$deleted" \
#             '{file: $file, author: {name: $author_name, email: $author_email, time: $commit_time}, key: $key, property: $property, value: $value, reason: $reason, deleted: $deleted}')
#           if [ "$first" = true ]; then
#             payload_array="$payload_array$payload"
#             first=false
#           else
#             payload_array="$payload_array,$payload"
#           fi
#         done < <(git diff --name-only --diff-filter=AM HEAD^1 HEAD | grep -E 'Charts/.*\.(yml|yaml)')
#         payload_array="$payload_array]"
#         curl -X POST -H "Content-Type: application/json" -d "$payload_array" "$SPRING_BOOT_URL"

